<!-- Payment Modal -->
<div
  *ngIf="selectedLoan"
  class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50"
>
  <div
    class="bg-gray-900 border border-gray-700 text-white rounded-xl shadow-lg w-full max-w-2xl p-6 relative"
  >
    <!-- Close Button -->
    <button
      class="absolute top-3 right-4 text-gray-400 hover:text-red-500 cursor-pointer"
      (click)="closePaymentModal()"
    >
      ✖
    </button>

    <div class="flex justify-between">
      <h2 class="text-lg font-semibold mb-4">Loan Payment</h2>
      <div class="flex gap-4 mr-10">
        <div class="flex flex-col justify-center items-center">
          <span class="font-medium">Total with Interest</span>
          <span class="font-semibold text-green-400"
            >₹{{ totalLoanAmount | number }}</span
          >
        </div>
        <div class="flex flex-col justify-center items-center">
          <span class="font-medium">Account Balance</span>
          <span class="font-semibold text-yellow-400"
            >₹{{ accountBalance | number }}</span
          >
        </div>
      </div>
    </div>

    <!-- Payment History Table -->
    <table class="w-full text-sm my-4 border border-gray-700 rounded">
      <thead class="bg-gray-800">
        <tr>
          <th class="p-2 text-left border-b border-gray-700">Date</th>
          <th class="p-2 text-left border-b border-gray-700">
            Amount Paid (₹)
          </th>
          <th class="p-2 text-left border-b border-gray-700">
            Remaining Amount (₹)
          </th>
        </tr>
      </thead>
      <tbody>
        <tr
          *ngFor="let payment of paymentHistory"
          class="border-b border-gray-700"
        >
          <td class="p-2">{{ payment.paymentDate | date : "mediumDate" }}</td>
          <td class="p-2">₹{{ payment.amountPaid }}</td>
          <td class="p-2">₹{{ payment.remainingBalanceAfterPayment }}</td>
        </tr>
        <tr *ngIf="!paymentHistory?.length">
          <td colspan="3" class="text-center py-3 text-gray-500">
            No payments yet.
          </td>
        </tr>
      </tbody>
    </table>

    <!-- Pay Form -->
    <div class="flex items-center gap-4">
      <input
        type="number"
        [(ngModel)]="paymentAmount"
        min="1"
        class="bg-gray-800 border border-gray-700 rounded px-3 py-2 w-full text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-indigo-500"
        placeholder="Enter amount to pay"
      />
      <button
        class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded"
        (click)="makePayment()"
      >
        Pay
      </button>
    </div>
  </div>
</div>

<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 m-3">
  <div
    *ngFor="let loan of loanHistory"
    class="bg-gray-900 text-gray-100 rounded-xl p-6 border border-gray-700 shadow-lg hover:shadow-xl transition-all"
  >
    <!-- Header with Loan Type -->
    <div class="flex items-center justify-between mb-4">
      <h2 class="text-lg font-semibold">Loan Details</h2>
      <span
        class="px-3 py-1 text-xs font-semibold rounded-full"
        [ngClass]="{
          'bg-blue-800 text-blue-200': loan.typeOfLoans === 1,
          'bg-green-800 text-green-200': loan.typeOfLoans === 2,
          'bg-purple-800 text-purple-200': loan.typeOfLoans === 0
        }"
      >
        {{
          loan.typeOfLoans === 1
            ? "Home Loan"
            : loan.typeOfLoans === 2
            ? "Personal Loan"
            : "Education Loan"
        }}
      </span>
    </div>

    <!-- General Loan Info -->
    <div class="space-y-2 text-sm">
      <p>
        <span class="font-medium text-gray-400">Amount:</span> ₹{{
          loan.amount | number
        }}
      </p>
      <p>
        <span class="font-medium text-gray-400">Terms:</span>
        {{ loan.terms }} years
      </p>
      <p>
        <span class="font-medium text-gray-400">Status:</span>
        <span
          [ngClass]="{
            'text-yellow-300': loan.status === 0,
            'text-green-400': loan.status === 1,
            'text-red-400': loan.status === 2,
            'text-green-600 font-bold': loan.status === 3
          }"
        >
          {{ loan.status === 0 ? "Pending" : loan.status === 1 ? "Approved" : loan.status === 2 ? "Rejected" : "Completed" }}
        </span>
      </p>
      <p>
        <span class="font-medium text-gray-400">Purpose:</span>
        {{ loan.purpose }}
      </p>
    </div>

    <!-- Education Loan Fields -->
    <div
      *ngIf="loan.instituteName || loan.courseName || loan.instituteCountry"
      class="mt-4 pt-4 border-t border-gray-700"
    >
      <p class="text-xs font-semibold text-gray-500 mb-2">Education Details</p>
      <p *ngIf="loan.instituteName">
        <strong>Institute:</strong> {{ loan.instituteName }}
      </p>
      <p *ngIf="loan.courseName">
        <strong>Course:</strong> {{ loan.courseName }}
      </p>
      <p *ngIf="loan.instituteCountry">
        <strong>Country:</strong> {{ loan.instituteCountry }}
      </p>
    </div>

    <!-- Home Loan Fields -->
    <div
      *ngIf="loan.propertyName || loan.propertyAddress"
      class="mt-4 pt-4 border-t border-gray-700"
    >
      <p class="text-xs font-semibold text-gray-500 mb-2">Property Details</p>
      <p *ngIf="loan.propertyName">
        <strong>Property:</strong> {{ loan.propertyName }}
      </p>
      <p *ngIf="loan.propertyAddress">
        <strong>Address:</strong> {{ loan.propertyAddress }}
      </p>
    </div>

    <!-- Personal Loan Fields -->
    <div
      *ngIf="loan.annualIncome || loan.proofOfWork"
      class="mt-4 pt-4 border-t border-gray-700"
    >
      <p class="text-xs font-semibold text-gray-500 mb-2">Work Details</p>
      <p *ngIf="loan.annualIncome">
        <strong>Annual Income:</strong> {{ loan.annualIncome }}
      </p>
      <p *ngIf="loan.workingOrganisation">
        <strong>Working Organisation:</strong> {{ loan.workingOrganisation }}
      </p>
    </div>

    <!-- Document Links -->
    <div
      *ngIf="loan.proofOfAdmission || loan.proofOfProperty || loan.proofOfWork"
      class="mt-4 pt-4 border-t border-gray-700"
    >
      <p class="text-xs font-semibold text-gray-500 mb-2">Documents</p>
      <div *ngIf="loan.proofOfAdmission">
        <a
          [href]="'data:application/pdf;base64,' + loan.proofOfAdmission"
          target="_blank"
          class="text-blue-400 hover:underline"
        >
          View Admission Proof
        </a>
      </div>
      <div *ngIf="loan.proofOfProperty">
        <a
          [href]="'data:application/pdf;base64,' + loan.proofOfProperty"
          target="_blank"
          class="text-blue-400 hover:underline"
        >
          View Property Proof
        </a>
      </div>
      <div *ngIf="loan.proofOfWork">
        <a
          [href]="'data:application/pdf;base64,' + loan.proofOfWork"
          target="_blank"
          class="text-blue-400 hover:underline"
        >
          View Work Proof
        </a>
      </div>
    </div>

    <!-- Payment -->
    <div *ngIf="loan.status === 1" class="mt-4">
      <button
        class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white text-sm font-medium rounded-md cursor-pointer"
        (click)="openPaymentModal(loan)"
      >
        Pay Loan
      </button>
    </div>
  </div>
</div>
